#!/bin/sh
#
# Generate the ifcfg script for an interface and save it in the overlay.
# Removes all existing versions ifcfg-* first.
# Assumes $1 is a valid interface.

progname=`basename $0`

usage () {
  echo "usage:"
  echo "$progname [-i ip_addr] [-n netmask] [-g gateway] <intf> <dhcp_config>"
  exit 1
}

while getopts i:n:g: opt; do
  case $opt in
    i)  ip_addr=$OPTARG;;
    n)  netmask=$OPTARG;;
    g)  gateway=$OPTARG;;
    \?) usage;;
    :)  echo "Option -$OPTARG requires an argument." >&2; exit 1;;
  esac
done
shift $((OPTIND-1))

if [ ! $# -eq 2 ]; then
  usage
fi

# Remove all other ifcfg-* files from filesystem and overlay.
for interface in `if_allowed`; do
  if [ $1 != $interface ]; then
    rm -f /etc/ifcfg-$interface
    ovlremove /etc/ifcfg-$interface
  fi
done

filename=/etc/ifcfg-$1
echo "# Generated by ifcfg-gen" > $filename
echo "dhcp_config=$2" >> $filename

if [ $2 = "disable" ]; then
    if [ $ip_addr ]; then
       echo "ip_addr=$ip_addr" >> $filename
    fi
    if [ $netmask ]; then
        echo "netmask=$netmask" >> $filename
    fi
    if [ $gateway ]; then
        echo "gateway=$gateway" >> $filename
    fi
fi

ovladd $filename
ovlsave
