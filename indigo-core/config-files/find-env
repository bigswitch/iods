#
# Shell script fragment to be sourced to pick up client environment 
# variables. idempotent:  Source it as many times as you like.
#
# This should always live in /etc/find-env
#
# Defines the following
#    client_cfg
#    client_root
#    sys_init_file
#    sys_config_file
#    client_rc_soc
#    client_config_bcm
#
# sysenv is an optional configuration file that does not exist by default
# If sysenv is found in one of the following locations, it is sourced at
# at the end (so it may override variable settings).
#    $client_cfg, $client_root/sfs, /etc
#

verbose=1

# Need to get the global environment from process with PID 1
if test $PPID != 1; then
    for line in `(cat /proc/1/environ; echo) | tr "\000" "\n"`; do
        export $line
    done
fi

[ $verbose = 1 ] && echo "Find env for DEV_ADDR $DEV_ADDR"

if test -z "$DEV_ADDR"; then
    export client_cfg=/config/unknown
    export client_root=/client/unknown
else
    export client_cfg=/config/$DEV_ADDR
    export client_root=/client/$DEV_ADDR
fi

# If sfs_dir is not defined, set it to a non-existent dir
if test -z "$sfs_dir"; then
    sfs_dir=/tmp/sfs
fi

# Find system_init file
sys_init_file=/etc/system_init
if test -e $client_cfg/system_init; then
    sys_init_file=$client_cfg/system_init
elif test -e /config/default/system_init; then
    sys_init_file=/config/default/system_init
elif test -e $sfs_dir/system_init; then
    sys_init_file=$sfs_dir/system_init
fi

# Find system_config file
sys_config_file=/etc/system_config
if test -e $client_cfg/system_config; then
    sys_config_file=$client_cfg/system_config
elif test -e /config/default/system_config; then
    sys_config_file=/config/default/system_config
elif test -e $sfs_dir/system_config; then
    sys_config_file=$sfs_dir/system_config
fi

# Find rc.soc file
if test -e $client_cfg/rc.soc; then
    export client_rc_soc=$client_cfg/rc.soc
elif test -e /config/default/rc.soc; then
    export client_rc_soc=/config/default/rc.soc
elif test -e $sfs_dir/rc.soc; then
    export client_rc_soc=$sfs_dir/rc.soc
elif test -e /etc/rc.soc; then
    export client_rc_soc=/etc/rc.soc
fi

# Find config.bcm file
if test -e $client_cfg/config.bcm; then
    export client_config_bcm=$client_cfg/config.bcm
elif test -e /config/default/config.bcm; then
    export client_config_bcm=/config/default/config.bcm
elif test -e $sfs_dir/config.bcm; then
    export client_config_bcm=$sfs_dir/config.bcm
elif test -e /etc/config.bcm; then
    export client_config_bcm=/etc/config.bcm
fi

# Now look for sysenv; this can redefine any of the above
if test -e $client_cfg/sysenv; then
    source $client_cfg/sysenv
    export sysenv_source=$client_cfg/sysenv
elif test -e $client_root/sfs/sysenv; then
    source $client_root/sfs/sysenv
    export sysenv_source=$client_root/sfs/sysenv
elif test -e /config/default/sysenv; then
    source /config/default/sysenv
    export sysenv_source=/config/default/sysenv
elif test -e /etc/sysenv; then
    source /etc/sysenv
    export sysenv_source=/etc/sysenv
fi
